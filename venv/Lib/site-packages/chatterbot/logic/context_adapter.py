from chatterbot.logic import LogicAdapter
import re

class ContextAdapter(LogicAdapter):
    def __init__(self, chatbot, **kwargs):
        super().__init__(chatbot, **kwargs)
        self.context = {}

    def can_process(self, statement):
        return True

    def process(self, input_statement, additional_response_selection_parameters=None):
        # Chuẩn hóa input: bỏ dấu, viết thường
        normalized_text = self.normalize(input_statement.text)
        
        # Pattern mới linh hoạt hơn
        name_patterns = [
            r'tôi tên là (.+)',
            r'tên tôi là (.+)',
            r'tên của tôi là (.+)',
            r'em tên là (.+)',
            r'cháu tên là (.+)',
            r'mình tên là (.+)'
        ]
        
        # Kiểm tra tất cả các pattern
        for pattern in name_patterns:
            match = re.search(pattern, normalized_text)
            if match:
                name = match.group(1).strip()
                if len(name) > 0:  # Đảm bảo tên không rỗng
                    self.context['user_name'] = name
                    break

        # Phản hồi
        if 'user_name' in self.context:
            response = f"Xin chào {self.context['user_name']}, bạn có khỏe không?"
        else:
            response = "Xin chào, bạn tên là gì?"
            
        output_statement = self.chatbot.storage.get_random()
        output_statement.text = response
        output_statement.confidence = 1
        
        return output_statement

    def normalize(self, text):
        """Chuẩn hóa văn bản để so sánh tốt hơn"""
        text = text.lower()
        text = re.sub(r'[^\w\s]', '', text)  # Bỏ dấu câu
        return text.strip()